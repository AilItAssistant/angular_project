<app-header></app-header>

<form class="text-center" [formGroup] = "filterForm">
  <div class="container  mt-5"> 
    <div class="row">
      <div class="col">
        <p>Elige un nivel</p>
        <select id="levelStatement" class="form-select mb-3" placeholder="A1" formControlName="level" aria-label="A1" (change)="chargeSkills()">
          @for(level of levels; track level.id){
            <option [value]="level.id">{{level.name}}</option>
          }
        </select>
      </div>
      @if(filterForm.value.level){
        <div class="col">
          <p>Elige una destreza</p>
          <select id="skillStatement" class="form-select" placeholder="Elige una destreza" formControlName="skill" aria-label="Elige una destreza" (change)="chargeBlocks()">
            @for(skill of skills; track skill.id){
              <option [value]="skill.id">{{skill.name}}</option>
            }
          </select>
        </div>
      }
      @if(filterForm.value.skill){
        <div class="col">
          <p>Elige un bloque</p>
          <select class="form-select" formControlName="block" aria-label="Select-block">
            @for(block of blocks; track block.id){
              <option [value]="block.id">{{block.name}}</option>
            }
          </select>
        </div>
      }
      @if(filterForm.value.level && filterForm.value.skill){
        <div class="col-1 mt-4">
          <button class="btn btn-success mt-3" (click)="chargeStatements()">Buscar</button>
          <button class="btn btn-success mt-3" (click)="infoResult()">Info</button>
        </div>
      }
    </div>
  </div>
</form>
<div class="text-center card-group mb-5 mt-3 container">
    @for(statement of statements; track statement.id){
      <div class="mx-auto">
        <div class="card m-2" style="width: 80rem;">
          <div class="card-header">
            <div class="row">
              <h5 class="col">Enunciado</h5>
              <p class="col">Puntuación : {{statement.score}}</p>
            </div>
          </div>
          <div class="card-body text-center">
            <p>Enunciado: {{statement.content}}</p>
            <p>Texto: {{statement.text}}</p>
            @if(statement.photo_id !== null){
              <p>Imagen del enunciado</p>
              <img [src]="statement.photo_id" style="width: 20rem; height: 15rem;">
            }
          </div>
          @for(question of statement.questions[0]; track question.id){
            <div class="card m-2">
              <div class="card-header">
                <div class="row">
                  <h5 class="col">Pregunta</h5>
                  <p class="col">Puntuación: {{question.puntuation}}</p>
                </div>
              </div>
              <div class="card-body text-center list-group list-group p-3">
                <p>Pregunta: {{question.content}}</p>
                @if(question.base64_data !== null){
                  <p>Imagen de la pregunta</p>
                  <img [src]="question.base64_data" style="width: 15rem; height: 15rem;">
                }
                <div class="card m-2">
                  @if(question.answers !== [] && question.answers !== null && question.answers !== undefined) {
                    <div class="card-header">
                      <h5>Respuestas</h5>
                    </div>
                    <div class="card-body text-center row">
                      @for(answer of question.answers; track answer.id){
                        <div class="col-3">
                          @if(answer.is_correct){
                              <p class="list-group"> <span class="text-success fs-3">{{answer.letter}}.</span> </p>
                              @if(answer.content && answer.content !== undefined && answer.content !== null){<p>{{answer.content}}</p>}
                            
                          } @else{
                           
                              <p class="list-group"> <span class="text-danger fs-3">{{answer.letter}}.</span> {{answer.content}}</p>
                              @if(answer.content && answer.content !== undefined && answer.content !== null){<p>{{answer.content}}</p>}
                            }
                            @if(answer.photo_id !== null){<img [src]="answer.base64_data"  style="width: 15rem; height: 15rem;">}
                          </div>
                      }
                    </div>
                  }
                </div>
              </div>
            </div>
          <div class="card-header">
            <button type="button" class="btn btn-primary mx-2" (click)="openEditModal(exam, question)">Editar</button>
            <button type="button" class="btn btn-primary mx-2" (click)="openDeleteModal(exam, question)">Eliminar</button>
          </div>
        }
        </div>
      </div>
    }
  </div>

<!-- Delete modal -->

  <div class="modal" id="deleteModal">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="staticBackdropLabel">¿Quiere borrar la pregunta?</h1>
          @if(!charge){
            <button type="button" class="btn-close" (click)="closeDeleteModal()"></button>
          } @else {
            <div class="spinner-border text-secondary mx-auto" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>            
          }
        </div>
        <div class="modal-body">
          {{modalStatement}}
          <ul>
            <li>{{modalResponseA}}</li>
            <li>{{modalResponseB}}</li>
            <li>{{modalResponseC}}</li>
            <li>{{modalResponseD}}</li>
            <li>{{modalResponseE}}</li>
          </ul>
          
        </div>
        @if (!charge){
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()">Cerrar</button>
            <button type="button" class="btn btn-primary" (click)="deleteQuestion()">Borrar</button>
          </div>
        } @else {
          <div class="spinner-border text-primary mx-auto mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>          
        }
      </div>
    </div>
  </div>

  <!-- Edit modal -->

  <div class="modal" id="editModal">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="staticBackdropLabel">Editar pregunta</h1>
          @if(!charge){
            <button type="button" class="btn-close" (click)="closeEditModal()"></button>
          } @else {
            <div class="spinner-border text-secondary mx-auto" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>            
          }
        </div>
        <div class="modal-body">
          
            <form [formGroup] = "questionForm">
        
                <p>Elige un nivel</p>
                <select class="form-select" placeholder="A1" formControlName="level" aria-label="Select-level">
                  @for(level of levels; track level.id){
                    <option [value]="level.id">{{level.name}}</option>
                  }
                </select>
                <p class="mt-1">Elige un bloque</p>
                <select class="form-select" formControlName="block" aria-label="Select-block">
                  @for(block of blocks; track block.id){
                    <option [value]="block.id">{{block.name}}</option>
                  }
                </select>
        
                <div class="input-group my-3">
                    <span class="input-group-text">Pregunta</span>
                    <textarea class="form-control" formControlName="question" id="question" aria-label="With textarea"></textarea>
                </div>
        
                <div class="input-group mb-1">
                    <span class="input-group-text" id="ResponseA">Respuesta A</span>
                    <input type="text" class="form-control" formControlName="responseA" placeholder="Respuesta" aria-label="ResponseA" aria-describedby="ResponseA">
                </div>
                
                <div class="input-group mb-1">
                    <span class="input-group-text" id="ResponseB">Respuesta B</span>
                    <input type="text" class="form-control" formControlName="responseB" placeholder="Respuesta" aria-label="Response" aria-describedby="Response">
                </div>
        
                    <div class="input-group mb-1">
                        <span class="input-group-text" id="ResponseC">Respuesta C</span>
                        <input type="text" class="form-control" formControlName="responseC" placeholder="Respuesta" aria-label="Response" aria-describedby="Response">
                    </div>
        
                    <div class="input-group mb-1">
                        <span class="input-group-text" id="ResponseD">Respuesta D</span>
                        <input type="text" class="form-control" formControlName="responseD" placeholder="Respuesta" aria-label="Response" aria-describedby="Response">
                    </div>
        
                    <div class="input-group mb-1">
                        <span class="input-group-text" id="ResponseE">Respuesta E</span>
                        <input type="text" class="form-control" formControlName="responseE" placeholder="Respuesta" aria-label="Response" aria-describedby="Response">
                    </div>
            </form>
        
        </div>
        @if (!charge){
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeEditModal()">Cerrar</button>
            <button type="button" class="btn btn-primary" (click)="editQuestion()">Editar</button>
          </div>
        } @else {
          <div class="spinner-border text-primary mx-auto mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>          
        }
      </div>
    </div>
  </div>

<app-footer></app-footer>